<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crop Data Entry Form</title>
  <style>
    @font-face {
      font-family: 'Suntommy';
      src: local('Suntommy'), url('Suntommy.ttf') format('truetype');
    }

    body {
      font-family: 'Suntommy', system-ui, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #2f4f4f;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 1.5em;
    }

    nav {
      background: #444;
      color: white;
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
    }

    nav div {
      cursor: pointer;
      font-weight: bold;
    }

    form {
      background: white;
      padding: 20px;
      margin: 20px auto;
      max-width: 900px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    label {
      display: inline-block;
      width: 120px;
      font-weight: bold;
      margin-bottom: 6px;
    }

    input, select, button {
      margin-bottom: 10px;
      padding: 6px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }

    th {
      background: #eee;
    }

    h3 {
      text-align: center;
      margin-top: 30px;
    }

    .totals {
      width: 90%;
      margin: 10px auto;
      background: #fffbe6;
      border: 1px solid #f0c36d;
      border-radius: 6px;
      padding: 10px;
    }

    button {
      background: #2f4f4f;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #1e3939;
    }

    /* Print styling */
    @media print {
      body { background: #fff; }
      nav, form, .totals { display: none; }
      table { page-break-inside: avoid; }
      .accountI { border: 4px solid green; }
      .abstractIA { border: 4px solid orange; }
      h3 { page-break-before: always; }
    }

    /* Colored borders for print view */
    #accountI { border: 4px solid green; }
    #abstractIA { border: 4px solid orange; }
  </style>
</head>
<body>
  <script src="auth.js"></script>
  <script>requireAuth();</script>
  <header>ğŸŒ¾ à®ªà®¯à®¿à®°à¯ à®¤à®•à®µà®²à¯ à®ªà®¤à®¿à®µà¯ (Crop Data Entry Form)</header>

  <nav id="topNav">
    <div onclick="exportExcel()">File</div>
    <div onclick="editLast()">Edit</div>
    <div onclick="exportSQL()">Tools</div>
    <div onclick="clearData()">Advanced</div>
    <div onclick="aboutInfo()">About</div>
  </nav>

  <form id="dataForm">
    <div><label>Survey No:</label> <input type="text" id="surveyNo" required></div>
    <div><label>SubDivision:</label> <input type="text" id="subDiv" required></div>
    <div><label>Month:</label> 
      <select id="month" required>
        <option value="">Select</option>
        <option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option>
        <option value="5">5</option><option value="6">6</option>
        <option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option>
        <option value="11">11</option><option value="12">12</option>
      </select>
    </div>
    <div><label>Crop:</label>
      <select id="crop" required>
        <option value="">Select</option>
        <option>à®¤à¯†à®©à¯à®©à¯†à®¯à¯</option>
        <option>à®¨à¯†à®²à¯</option>
        <option>à®•à®°à¯à®®à¯à®ªà¯</option>
        <option>à®ªà®°à¯à®ªà¯à®ªà¯</option>
        <option>à®šà¯‹à®³à®®à¯</option>
        <option>à®®à®•à¯à®•à®¾à®šà¯à®šà¯‹à®³à®®à¯</option>
        <option>à®µà¯‡à®°à¯à®•à¯à®•à®Ÿà®²à¯ˆ</option>
      </select>
    </div>
    <div><label>Area:</label> <input type="number" step="0.01" id="area" required></div>
    <button type="submit">Save Entry</button>
  </form>

  <h3>ğŸ“‹ à®ªà®¤à®¿à®µà¯à®•à®³à¯ (Entries)</h3>
  <table id="dataTable">
    <thead>
      <tr><th>Sl.No</th><th>Survey No</th><th>SubDivision</th><th>Month</th><th>Crop</th><th>Area</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="totals">
    <h4>ğŸŒ± Crop-wise Total</h4>
    <ul id="cropTotals"></ul>
    <h4>ğŸ—“ï¸ Month-wise Total</h4>
    <ul id="monthTotals"></ul>
  </div>

  <h3>ğŸ“ˆ Analysis Charts</h3>
  <div style="width:90%;margin:0 auto 24px auto;background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05);">
    <canvas id="cropChart" height="90"></canvas>
    <canvas id="monthChart" height="90" style="margin-top:18px;"></canvas>
  </div>

  <h3>ğŸ“„ Account I - Month-wise</h3>
  <table id="accountI" class="accountI">
    <thead>
      <tr>
        <th>Month</th>
        <th>Crop</th>
        <th>Total Area</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>ğŸ“Š Abstract I-A - Crop Totals</h3>
  <table id="abstractIA" class="abstractIA">
    <thead>
      <tr>
        <th>Crop</th>
        <th>Total Area</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    if (typeof injectUserBadge === 'function') {
      injectUserBadge('#topNav');
    }

    let entries = JSON.parse(localStorage.getItem("cropEntries") || "[]");
    const tableBody = document.querySelector("#dataTable tbody");

    function refreshTable() {
      tableBody.innerHTML = "";
      entries.forEach((e, i) => {
        const row = `<tr>
          <td>${i + 1}</td>
          <td>${e.survey}</td>
          <td>${e.subDiv}</td>
          <td>${e.month}</td>
          <td>${e.crop}</td>
          <td>${e.area}</td>
        </tr>`;
        tableBody.insertAdjacentHTML("beforeend", row);
      });
      calcTotals();
      refreshAccountI();
      refreshAbstractIA();
    }

    let cropChart, monthChart;

    function calcTotals() {
      let cropTotals = {}, monthTotals = {};
      entries.forEach(e => {
        const areaVal = parseFloat(e.area) || 0;
        cropTotals[e.crop] = (cropTotals[e.crop] || 0) + areaVal;
        monthTotals[e.month] = (monthTotals[e.month] || 0) + areaVal;
      });

      document.querySelector("#cropTotals").innerHTML =
        Object.entries(cropTotals).map(([k,v]) => `<li>${k}: ${v.toFixed(2)}</li>`).join("");
      document.querySelector("#monthTotals").innerHTML =
        Object.entries(monthTotals).map(([k,v]) => `<li>${k}: ${v.toFixed(2)}</li>`).join("");

      updateCharts(cropTotals, monthTotals);
    }

    function updateCharts(cropTotals, monthTotals) {
      if (typeof Chart === 'undefined') return;

      const cropCtx = document.getElementById('cropChart').getContext('2d');
      const monthCtx = document.getElementById('monthChart').getContext('2d');

      const cropLabels = Object.keys(cropTotals);
      const cropData = cropLabels.map(k => Number((cropTotals[k] || 0).toFixed(2)));

      const monthLabels = Object.keys(monthTotals).sort((a,b)=>Number(a)-Number(b));
      const monthData = monthLabels.map(k => Number((monthTotals[k] || 0).toFixed(2)));

      if (cropChart) cropChart.destroy();
      if (monthChart) monthChart.destroy();

      cropChart = new Chart(cropCtx, {
        type: 'bar',
        data: {
          labels: cropLabels,
          datasets: [{
            label: 'Area by Crop',
            data: cropData,
            backgroundColor: 'rgba(34,197,94,0.6)',
            borderColor: 'rgba(22,163,74,1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      monthChart = new Chart(monthCtx, {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{
            label: 'Area by Month',
            data: monthData,
            borderColor: 'rgba(37,99,235,1)',
            backgroundColor: 'rgba(59,130,246,0.28)',
            tension: 0.25,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function refreshAccountI() {
      const accountBody = document.querySelector("#accountI tbody");
      accountBody.innerHTML = "";
      const monthCropTotals = {};
      entries.forEach(e => {
        const key = e.month + "-" + e.crop;
        monthCropTotals[key] = (monthCropTotals[key] || 0) + parseFloat(e.area);
      });
      Object.entries(monthCropTotals).forEach(([k,v]) => {
        const [month, crop] = k.split("-");
        const row = `<tr>
          <td>${month}</td>
          <td>${crop}</td>
          <td>${v.toFixed(2)}</td>
        </tr>`;
        accountBody.insertAdjacentHTML("beforeend", row);
      });
    }

    function refreshAbstractIA() {
      const abstractBody = document.querySelector("#abstractIA tbody");
      abstractBody.innerHTML = "";
      const cropTotals = {};
      entries.forEach(e => {
        cropTotals[e.crop] = (cropTotals[e.crop] || 0) + parseFloat(e.area);
      });
      Object.entries(cropTotals).forEach(([crop, total]) => {
        const row = `<tr><td>${crop}</td><td>${total.toFixed(2)}</td></tr>`;
        abstractBody.insertAdjacentHTML("beforeend", row);
      });
    }
document.querySelector("#dataForm").addEventListener("submit", e => {
  e.preventDefault();

  const cropSelect = document.querySelector("#crop");
  const newCrop = crop.value.trim();

  // Add new crop to dropdown if not exists
  if (newCrop && !Array.from(cropSelect.options).some(opt => opt.value === newCrop)) {
    const option = document.createElement("option");
    option.value = newCrop;
    option.textContent = newCrop;
    cropSelect.appendChild(option);
  }

  const newEntry = {
    survey: surveyNo.value,
    subDiv: subDiv.value,
    month: month.value,
    crop: newCrop,
    area: parseFloat(area.value)
  };

  entries.push(newEntry);
  localStorage.setItem("cropEntries", JSON.stringify(entries));
  refreshTable();
  e.target.reset();
});

    document.querySelector("#dataForm").addEventListener("submit", e => {
      e.preventDefault();
      const newEntry = {
        survey: surveyNo.value,
        subDiv: subDiv.value,
        month: month.value,
        crop: crop.value,
        area: parseFloat(area.value)
      };
      entries.push(newEntry);
      localStorage.setItem("cropEntries", JSON.stringify(entries));
      refreshTable();
      e.target.reset();
    });

    function exportExcel() {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(entries);
      XLSX.utils.book_append_sheet(wb, ws, "Entries");
      XLSX.writeFile(wb, "CropData.xlsx");
    }

    function exportSQL() {
      const sql = entries.map(e => 
        `INSERT INTO crop_data (survey, subdivision, month, crop, area) VALUES ('${e.survey}','${e.subDiv}',${e.month},'${e.crop}',${e.area});`
      ).join("\n");
      const blob = new Blob([sql], {type: "text/sql"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "CropData.sql";
      a.click();
    }

    function clearData() {
      if (confirm("Clear all saved entries?")) {
        entries = [];
        localStorage.removeItem("cropEntries");
        refreshTable();
      }
    }

    function aboutInfo() {
      alert("Crop Data Entry Form\nDeveloped by Muniyappan\nUses LocalStorage + Tamil Font Suntommy\nPrint-ready Account I (green) & Abstract I-A (orange)");
    }

    function editLast() {
      if (entries.length === 0) return alert("No entries to edit!");
      const last = entries.pop();
      surveyNo.value = last.survey;
      subDiv.value = last.subDiv;
      month.value = last.month;
      crop.value = last.crop;
      area.value = last.area;
      localStorage.setItem("cropEntries", JSON.stringify(entries));
      refreshTable();
    }

    refreshTable();
  </script>
</body>
</html>
